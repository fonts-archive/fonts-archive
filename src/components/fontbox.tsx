// react hooks
import React, { useEffect } from 'react';
import { useInfiniteQuery } from 'react-query';
import { useInView } from 'react-intersection-observer';

// hooks
import axios from 'axios';

// 컴포넌트
import DummyText from "./dummytext";

export default function FontBox ({lang, type, sort, searchword, text, num}:{lang: string, type: string, sort: string, searchword: string, text: string, num: number}) {
    // react-intersection-observer 훅
    const { ref, inView } = useInView();

    // react-intersection-observer 사용해 ref를 지정한 요소가 viewport에 있을 때 fetchNextPage 함수 실행
    useEffect(() => {
        if (inView && hasNextPage) { fetchNextPage(); }
    // eslint-disable-next-line react-hooks/exhaustive-deps
    }, [inView]);

    // useInfiniteQuery 사용해 다음에 불러올 데이터 업데이트
    const {
        isLoading,
        data,
        remove,
        refetch,
        fetchNextPage,
        hasNextPage
    } = useInfiniteQuery('fonts', async ({ pageParam = '' }) => {
        await new Promise((res) => setTimeout(res, 100));
        const res = await axios.get('/api/fontlist', {params: { id: pageParam, lang: lang, type: type, sort: sort, searchword: searchword }});
        return res.data;
    },{
        getNextPageParam: (lastPage) => lastPage.nextId ?? false,
    });

    // 폰트 검색 필터링 값 변경 시 기존 데이터 지우고 useInfiniteQuery 재실행
    useEffect(() => {
        remove();
        refetch();
    }, [lang, type, sort, searchword, remove, refetch]);

    return (
        <>
            <div className='w-[100%] flex flex-col justify-start items-end'>
                <div className="main-menu w-[100%] relative flex flex-wrap flex-row justify-between items-stretch mt-[60px] tlg:mt-[56px] p-[20px] tlg:p-[16px] tmd:p-[12px] pt-[10px] tlg:pt-[10px] tmd:pt-[10px]">
                    {/* 로딩 바 */}
                    {isLoading ? <div className="w-[100%] pt-[28px] pb-0 flex flex-row justify-center items-center"><span className="loader"></span></div> : null}

                    {/* Google AdSense */}
                    {/* <div style={isLoading ? {display: "none"} : {display: "flex"}} className="w-[calc(25%-8px)] txl:w-[calc(33.3%-6px)] tlg:w-[calc(50%-4px)] tmd:w-[100%] h-[360px] txl:h-[300px] tlg:h-[240px] tmd:h-[220px] flex flex-row justify-center items-center border border-theme-7 dark:border-theme-4 cursor-pointer">
                        <svg className="h-[32px] fill-theme-7 dark:fill-theme-5" viewBox="0 0 1000 145" xmlns="http://www.w3.org/2000/svg">
                            <path fillRule="evenodd" clipRule="evenodd" d="M989.383 84.5722C989.162 81.5433 987.772 78.6558 985.21 75.9049C982.643 73.1682 978.837 71.7927 973.777 71.7927C970.094 71.7927 966.905 72.9468 964.192 75.2596C961.483 77.5677 959.623 80.6766 958.614 84.5769H989.383L989.383 84.5722ZM975.082 119.241C967.065 119.241 960.546 116.575 955.534 111.229C950.503 105.882 947.997 99.1323 947.997 90.969C947.997 83.2438 950.432 76.5974 955.308 71.0343C960.183 65.4712 966.415 62.692 973.994 62.692C981.865 62.692 988.173 65.2545 992.902 70.3842C997.631 75.5139 1000 82.3723 1000 90.9689L999.888 92.806H957.965C958.252 98.1571 960.042 102.382 963.325 105.487C966.613 108.595 970.457 110.145 974.866 110.145C982.016 110.145 986.854 107.112 989.383 101.045L998.267 104.728C996.534 108.845 993.679 112.298 989.704 115.077C985.738 117.851 980.858 119.246 975.082 119.246L975.082 119.241ZM921.958 119.246C916.036 119.246 911.147 117.8 907.284 114.912C903.513 112.146 900.57 108.399 898.777 104.078L907.661 100.395C910.478 107.041 915.283 110.362 922.071 110.362C925.18 110.362 927.723 109.679 929.711 108.304C931.689 106.933 932.688 105.124 932.688 102.882C932.688 99.4196 930.272 97.0739 925.429 95.8444L914.704 93.2395C911.307 92.3775 908.095 90.7335 905.061 88.3171C902.032 85.8959 900.511 82.6268 900.511 78.5098C900.511 73.8136 902.583 70.0027 906.743 67.0823C910.888 64.1571 915.82 62.6921 921.529 62.6921C926.22 62.6921 930.413 63.7614 934.096 65.8858C937.71 67.935 940.504 71.17 942.005 75.043L933.338 78.6182C931.388 73.922 927.346 71.5761 921.204 71.5761C918.236 71.5761 915.754 72.1932 913.728 73.4179C911.703 74.6473 910.695 76.3101 910.695 78.4015C910.695 81.4351 913.041 83.4935 917.742 84.577L928.246 87.0688C933.234 88.2229 936.913 90.2107 939.297 93.0276C941.685 95.8445 942.872 99.0239 942.872 102.562C942.872 107.329 940.922 111.299 937.021 114.479C933.121 117.654 928.1 119.246 921.962 119.246M854.033 64.4255V71.788H854.466C855.907 69.2632 858.187 67.1151 861.291 65.344C864.321 63.5947 867.76 62.6797 871.259 62.692C877.834 62.692 882.847 64.7175 886.318 68.7591C889.785 72.8007 891.519 78.2272 891.519 85.0102V117.512H881.551V86.5224C881.551 76.701 877.18 71.7881 868.447 71.7881C864.33 71.7881 860.971 73.4367 858.366 76.7199C855.766 80.0078 854.466 83.8139 854.466 88.1475V117.513H844.503V64.4256C844.503 64.4256 854.033 64.4256 854.033 64.4255ZM825.539 84.5722C825.322 81.5433 823.928 78.6558 821.366 75.9049C818.803 73.1682 814.992 71.7927 809.938 71.7927C806.254 71.7927 803.061 72.9468 800.348 75.2596C797.639 77.5677 795.783 80.6766 794.77 84.5769H825.539V84.5722ZM811.238 119.241C803.221 119.241 796.702 116.575 791.685 111.229C786.664 105.882 784.153 99.1323 784.153 90.969C784.153 83.2438 786.588 76.5974 791.468 71.0343C796.344 65.4712 802.571 62.692 810.155 62.692C818.026 62.692 824.328 65.2545 829.062 70.3842C833.792 75.5139 836.156 82.3723 836.156 90.9689L836.048 92.806H794.12C794.412 98.1571 796.198 102.382 799.485 105.487C802.769 108.595 806.612 110.145 811.021 110.145C818.177 110.145 823.01 107.112 825.539 101.045L834.423 104.728C832.694 108.845 829.835 112.298 825.864 115.077C821.893 117.851 817.013 119.246 811.238 119.246L811.238 119.241ZM751.241 119.246C745.612 119.246 740.101 117.399 734.721 113.721C729.342 110.037 725.818 104.874 724.156 98.2279L733.261 94.5443C734.303 98.7436 736.632 102.512 739.922 105.322C743.275 108.247 747.049 109.712 751.236 109.712C755.575 109.712 759.272 108.572 762.344 106.297C765.415 104.026 766.95 100.936 766.95 97.0361C766.95 92.7024 765.415 89.3627 762.344 87.0121C759.272 84.6664 754.416 82.4807 747.774 80.4599C740.911 78.2931 735.706 75.4951 732.168 72.0612C728.635 68.632 726.864 64.2465 726.864 58.8954C726.864 53.3371 729.069 48.4947 733.478 44.3778C737.877 40.2608 743.619 38.207 750.699 38.207C757.27 38.207 762.617 39.851 766.734 43.1389C770.851 46.422 773.517 50.0162 774.751 53.9165L765.65 57.7083C765.005 55.2542 763.389 52.9791 760.831 50.8829C758.264 48.7867 754.962 47.741 750.921 47.741C747.086 47.741 743.822 48.8055 741.113 50.9347C738.405 53.0685 737.048 55.7253 737.048 58.8954C737.048 61.7923 738.297 64.2229 740.788 66.2107C743.28 68.1985 746.945 69.9886 751.783 71.576C755.612 72.8054 758.801 73.9972 761.373 75.1513C764.122 76.418 766.736 77.9598 769.174 79.7534C771.807 81.6659 773.79 84.0494 775.132 86.9086C776.466 89.7584 777.134 93.0605 777.134 96.8194C777.134 100.574 776.362 103.932 774.807 106.895C773.371 109.723 771.248 112.144 768.632 113.937C763.495 117.404 757.438 119.253 751.241 119.246ZM689.477 110.141C694.169 110.141 698.159 108.412 701.447 104.94C704.73 101.473 706.378 96.8195 706.378 90.9691C706.378 85.1187 704.73 80.4553 701.447 76.9931C698.159 73.5263 694.169 71.7881 689.482 71.7881C684.856 71.7881 680.881 73.5403 677.565 77.0449C674.234 80.5495 672.571 85.194 672.571 90.969C672.571 96.744 674.234 101.389 677.565 104.888C680.881 108.393 684.856 110.141 689.482 110.141M687.847 119.246C680.984 119.246 675.063 116.533 670.089 111.116C665.096 105.703 662.609 98.9862 662.609 90.969C662.609 82.9517 665.096 76.2347 670.084 70.8129C675.063 65.3958 680.984 62.692 687.847 62.692C691.898 62.692 695.526 63.554 698.738 65.2922C701.951 67.0257 704.353 69.1925 705.945 71.7927H706.378L705.945 64.4255V39.9405H715.908V117.508H706.379V110.141H705.945C704.353 112.745 701.951 114.912 698.738 116.646C695.521 118.375 691.894 119.246 687.847 119.246ZM612.23 87.1724H638.02L625.34 52.1784H624.906L612.23 87.1771L612.23 87.1724ZM590.232 117.508L619.484 39.9406H630.761L660.013 117.508H648.962L641.482 96.4992H608.872L601.288 117.508H590.237H590.232Z"/><path fillRule="evenodd" clipRule="evenodd" d="M519.024 90.1189L544.29 79.624C542.896 76.0911 538.727 73.6323 533.8 73.6323C527.484 73.6322 518.708 79.2 519.024 90.1189ZM548.681 100.289L558.314 106.709C555.214 111.316 547.715 119.239 534.761 119.239C518.708 119.239 507.111 106.817 507.111 90.9762C507.111 74.1598 518.812 62.7086 533.372 62.7086C548.04 62.7086 555.214 74.3812 557.565 80.698L558.851 83.9104L521.058 99.5397C523.951 105.216 528.444 108.103 534.761 108.103C541.073 108.103 545.468 104.995 548.681 100.284M487.435 117.524H499.852V34.4459H487.435V117.524ZM467.175 91.0799C467.175 81.1267 460.534 73.8442 452.078 73.8442C443.519 73.8442 436.341 81.1266 436.341 91.0799C436.341 100.929 443.519 108.104 452.074 108.104C460.534 108.104 467.175 100.929 467.175 91.0799ZM478.09 64.4233V115.169C478.09 136.046 465.781 144.614 451.221 144.614C437.514 144.614 429.27 135.405 426.171 127.911L436.981 123.412C438.913 128.015 443.623 133.474 451.221 133.474C460.534 133.474 466.318 127.694 466.318 116.884V112.814H465.889C463.106 116.238 457.75 119.239 451.004 119.239C436.873 119.239 423.919 106.926 423.919 91.0798C423.919 75.1302 436.873 62.7086 451.004 62.7086C457.75 62.7086 463.106 65.7045 465.889 69.0254H466.313V64.4233H478.09ZM342.569 90.9762C342.569 80.8015 335.315 73.8442 326.907 73.8442C318.499 73.8442 311.245 80.8063 311.245 90.9762C311.245 101.038 318.499 108.103 326.907 108.103C335.315 108.104 342.569 101.038 342.569 90.9762ZM354.76 90.9762C354.76 107.246 342.254 119.239 326.907 119.239C311.56 119.239 299.054 107.246 299.054 90.9762C299.054 74.5932 311.56 62.7133 326.907 62.7133C342.254 62.7134 354.76 74.5885 354.76 90.9762ZM405.016 90.9762C405.016 80.8015 397.762 73.8442 389.354 73.8442C380.946 73.8442 373.691 80.8063 373.691 90.9762C373.691 101.038 380.946 108.103 389.354 108.103C397.762 108.103 405.016 101.038 405.016 90.9762ZM417.211 90.9762C417.211 107.246 404.7 119.239 389.354 119.239C374.007 119.239 361.501 107.246 361.501 90.9762C361.501 74.5932 374.007 62.7133 389.354 62.7133C404.7 62.7133 417.211 74.5885 417.211 90.9762ZM251.328 119.239C227.139 119.239 206.795 99.5398 206.795 75.3469C206.795 51.1492 227.139 31.4453 251.332 31.4453C264.72 31.4453 274.244 36.6974 281.418 43.5512L272.958 52.0065C267.819 47.1876 260.862 43.4428 251.332 43.4428C233.668 43.4428 219.852 57.6825 219.852 75.3468C219.852 93.011 233.668 107.246 251.332 107.246C262.788 107.246 269.317 102.644 273.495 98.4658C276.92 95.046 279.171 90.1188 280.024 83.3735H251.328V71.3853H291.687C292.12 73.5238 292.332 76.0957 292.332 78.8749C292.332 87.8719 289.869 99.0075 281.951 106.93C274.239 114.957 264.39 119.239 251.328 119.239Z"/><path fillRule="evenodd" clipRule="evenodd" d="M92.6652 35.5987C99.2976 24.2465 95.3596 9.73821 83.8708 3.18129C72.3772 -3.36631 57.6853 0.515116 51.053 11.8673C50.7607 12.3759 50.4857 12.8944 50.2286 13.4218L27.8068 51.7791C27.3108 52.5416 26.8517 53.3276 26.4313 54.1343L3.14746 94.3146L44.755 117.636L67.921 77.7949C68.4258 77.0379 68.8852 76.2514 69.2964 75.4397L91.7182 37.0777C92.0434 36.5973 92.3685 36.1074 92.6652 35.5987Z"/><mask id="path-4-inside-1_623_3" fill="white"><path fillRule="evenodd" clipRule="evenodd" d="M44.948 117.514C38.3533 129.05 23.4776 133.294 12.0547 126.639C0.627145 119.978 -3.42857 105.536 3.17078 94.0043C9.77012 82.4732 24.5139 78.2102 35.9415 84.8661C47.3691 91.5267 51.5425 105.983 44.9479 117.51"/></mask>
                            <path fillRule="evenodd" clipRule="evenodd" d="M44.948 117.514C38.3533 129.05 23.4776 133.294 12.0547 126.639C0.627145 119.978 -3.42857 105.536 3.17078 94.0043C9.77012 82.4732 24.5139 78.2102 35.9415 84.8661C47.3691 91.5267 51.5425 105.983 44.9479 117.51"/><path d="M12.0547 126.639L11.5512 127.503L11.5513 127.503L12.0547 126.639ZM35.9415 84.8661L36.445 84.0021L36.4448 84.002L35.9415 84.8661ZM44.0798 117.018C37.7506 128.09 23.4833 132.14 12.5582 125.775L11.5513 127.503C23.4719 134.448 38.9561 130.011 45.8161 118.011L44.0798 117.018ZM12.5583 125.775C1.59444 119.384 -2.28172 105.545 4.03869 94.5011L2.30286 93.5076C-4.57542 105.526 -0.340147 120.572 11.5512 127.503L12.5583 125.775ZM4.03869 94.5011C10.3746 83.4301 24.5117 79.3662 35.4382 85.7302L36.4448 84.002C24.5161 77.0542 9.1656 81.5162 2.30286 93.5076L4.03869 94.5011ZM35.4379 85.73C46.4092 92.1247 50.3915 105.981 44.0799 117.013L45.8158 118.006C52.6935 105.985 48.3289 90.9287 36.445 84.0021L35.4379 85.73Z" mask="url(#path-4-inside-1_623_3)"/><path fillRule="evenodd" clipRule="evenodd" d="M134.734 43.1933C123.377 36.648 108.865 40.524 102.283 51.8606L78.5285 92.9076C71.9837 104.221 75.8494 118.698 87.1627 125.243C87.1832 125.254 87.2035 125.266 87.224 125.278C98.5835 131.826 113.099 127.947 119.679 116.606L143.429 75.5636C149.973 64.2467 146.104 49.7677 134.787 43.2239C134.769 43.2137 134.751 43.2035 134.734 43.1933Z"/>
                        </svg>
                    </div> */}

                    {/* fetchNextPage */}
                    {data && data.pages.map((page) => {
                        return (
                            <React.Fragment key={page.nextId ?? 'lastPage'}>
                                {page.fonts.map((font: {
                                    code: number
                                    name: string
                                    lang: string
                                    date: string
                                    source: string
                                    font_family: string
                                    font_type: string
                                    cdn_url: string
                                }) => (
                                    <a aria-label="font-link" href={`/DetailPage/${font.code}`} key={font.code} className="w-[calc(25%-8px)] txl:w-[calc(33.3%-6px)] tlg:w-[calc(50%-4px)] tmd:w-[100%] h-[360px] txl:h-[300px] tlg:h-[240px] tmd:h-[220px] block p-[20px] tlg:p-[16px] border border-theme-7 dark:border-theme-4 rounded-[8px] mt-[12px] txl:mt-[10px] cursor-pointer hover:bg-theme-8/60 tlg:hover:bg-transparent hover:dark:bg-theme-3/40 tlg:hover:dark:bg-transparent animate-fontbox-fade-in">
                                        <link href={font.cdn_url} rel="stylesheet" type="text/css" itemProp="url"></link>
                                        <div style={{fontFamily:"'"+font.font_family+"'"}} className="text-[18px] tlg:text-[16px] text-normal leading-tight mb-[8px] tlg:mb-[6px] text-theme-3 dark:text-theme-8">{font.name}</div>
                                        <div className="flex flex-row justify-start items-center">
                                            <div style={{fontFamily:"'"+font.font_family+"'"}} className="inline-block text-[14px] tlg:text-[12px] text-normal text-theme-5 dark:text-theme-6 leading-tight"><span className="text-theme-3 dark:text-theme-8">by</span> {font.source}</div>
                                        </div>
                                        <div className="w-[100%] h-px my-[16px] tlg:my-[12px] bg-theme-7 dark:bg-theme-5"></div>
                                        <div style={{fontFamily:"'"+font.font_family+"'"}} className="text-[36px] txl:text-[32px] tlg:text-[24px] text-normal leading-normal overflow-hidden">
                                            <p className="ellipsed-text text-theme-3 dark:text-theme-8"><DummyText lang={font.lang} text={text} num={num}/></p>
                                        </div>
                                    </a>
                                ))}
                            </React.Fragment>
                        )
                    })}

                    {/* 정렬 맞추기 위한 빈 div */}
                    <div className="w-[calc(25%-8px)] txl:w-[calc(33.3%-6px)] tlg:w-[calc(50%-4px)] tmd:w-[100%]"></div>
                    <div className="w-[calc(25%-8px)] txl:w-[calc(33.3%-6px)] tlg:w-[calc(50%-4px)] tmd:w-[100%]"></div>
                    <div className="w-[calc(25%-8px)] txl:w-[calc(33.3%-6px)] tlg:w-[calc(50%-4px)] tmd:w-[100%]"></div>

                    {/* 뷰포트 만날 시 다음 데이터 로딩 */}
                    <span className="w-[100%]" ref={ref}></span>

                    {/* 로딩 바 */}
                    {hasNextPage ? <div className="w-[100%] pt-[28px] tmd:pt-[16px] pb-0 flex flex-row justify-center items-center"><span className="loader"></span></div> : null}
                </div>
            </div>
        </>
    )
}